<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Word Crumble: Susie Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* BACKGROUND */
            --bg-body: radial-gradient(circle at top, #2c3e50 0%, #0a0f14 100%);
            
            /* TILE PALETTE */
            --t-red: #ff5e57;    /* A */
            --t-yellow: #ffdd59; /* E */
            --t-blue: #0fb9b1;   /* O */
            --t-purple: #a55eea; /* U */
            --t-white: #d2dae2;  /* I */
            --t-base: #808e9b;   /* Consonants */
            --t-epic: #1e272e;   /* High Score */
            
            /* UI COLORS */
            --ui-gold: #ffd32a;
            --ui-green: #2ecc71;
            --ui-dark: #2d3436;
            --ui-red: #ff3f34;
            --ui-cyan: #00d2d3;
        }

        * { user-select: none; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Nunito', sans-serif; 
            background: var(--bg-body); color: white; margin: 0; padding: 15px; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow: hidden;
        }

        /* --- TILE DESIGN --- */
        .cell {
            position: absolute; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 900; cursor: pointer; z-index: 10;
            border-radius: 8px; 
            box-shadow: 0 5px 0 rgba(0,0,0,0.3), 0 5px 10px rgba(0,0,0,0.2);
            border-bottom: 4px solid rgba(0,0,0,0.2);
            transition: top 0.4s ease, left 0.4s ease, transform 0.1s;
        }
        
        .cell:active { transform: translateY(4px); border-bottom-width: 0px; box-shadow: none; }

        .tile-letter { 
            font-size: 1.8rem; z-index: 2; margin-top: -4px; 
            text-shadow: 0 1px 1px rgba(0,0,0,0.2); 
        }
        .tile-score { 
            position: absolute; bottom: 3px; right: 5px; 
            font-size: 0.7rem; opacity: 0.8; font-weight: 900; 
        }

        /* Color Classes */
        .bg-A { background: var(--t-red); color: white; }
        .bg-E { background: var(--t-yellow); color: #1e272e; }
        .bg-I { background: var(--t-white); color: #1e272e; }
        .bg-O { background: #3498db; color: white; }
        .bg-U { background: var(--t-purple); color: white; }
        .bg-cons { background: var(--t-base); color: white; }
        .bg-mid { background: #4bcffa; color: #1e272e; }
        .bg-epic { background: var(--t-epic); color: #dfe6e9; border: 1px solid #636e72; }

        .cell.selected { 
            transform: translateY(-6px) scale(1.05); z-index: 100;
            filter: brightness(1.2); border: 2px solid white;
        }
        .cell.removing { transform: scale(0.1) rotate(15deg); opacity: 0; transition: 0.3s ease-in; }

        .start-tile {
            border: 3px solid var(--ui-gold) !important;
            box-shadow: 0 0 20px var(--ui-gold) !important;
            animation: pulseGold 2s infinite;
        }
        @keyframes pulseGold { 0% { border-color: var(--ui-gold); } 50% { border-color: white; } 100% { border-color: var(--ui-gold); } }

        /* --- UI LAYOUT --- */
        #game-view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 480px; height: 100%; }
        
        .header-bar {
            width: 100%; display: flex; justify-content: space-between; margin-bottom: 5px;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-pill { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px;
        }
        .stat-val { font-size: 1.2rem; font-weight: 900; color: white; }

        /* DICTIONARY POP-UP (TOP) */
        #def-modal {
            width: 90%; max-width: 450px; min-height: 50px;
            background: rgba(20, 20, 30, 0.95); border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px); padding: 15px; border-radius: 12px;
            text-align: center; z-index: 5000; margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; transform: translateY(-20px); pointer-events: none; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: absolute; top: 75px; 
        }
        #def-modal.visible { opacity: 1; transform: translateY(0); pointer-events: all; }
        
        #def-word { display: block; color: var(--ui-gold); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        #def-text { font-size: 0.95rem; font-weight: 700; line-height: 1.3; color: white; }

        #clue-bar {
            background: rgba(255, 211, 42, 0.15); border: 1px solid var(--ui-gold);
            color: var(--ui-gold); padding: 12px; width: 100%; text-align: center; border-radius: 10px;
            font-size: 1rem; font-weight: 800; margin-bottom: 5px; transition: all 0.3s ease;
        }
        #clue-bar.solved { background: rgba(46, 204, 113, 0.2); border-color: var(--ui-green); color: var(--ui-green); }

        #word-display { 
            height: 50px; font-size: 2.2rem; font-weight: 900; 
            text-shadow: 0 4px 8px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px; color: white; letter-spacing: 2px;
        }

        #game-container { position: relative; margin: 0 auto; width: 100%; transition: width 0.3s ease; }

        .controls { 
            position: fixed; bottom: 20px; display: flex; gap: 10px; width: 90%; max-width: 450px; z-index: 200; 
        }
        .game-btn { 
            flex: 1; padding: 18px 0; border-radius: 14px; border: none; font-weight: 900; 
            cursor: pointer; color: white; text-transform: uppercase; font-size: 0.9rem;
            box-shadow: 0 5px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-green { background: #05c46b; }
        .btn-red { background: var(--ui-red); }
        .btn-end { background: #d63031; }
        .btn-share { background: var(--ui-cyan); color: #2d3436; } 

        /* --- MODALS --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(10, 15, 20, 0.95); z-index: 9000;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: all; }
        
        .modal-card { 
            background: #2d3436; width: 100%; max-width: 380px; border-radius: 24px; padding: 30px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); max-height: 95vh; overflow-y: auto;
        }
        
        h2 { color: var(--ui-gold); margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 1px; }
        
        /* NEW LANDING SCREEN BUTTONS */
        .landing-btn {
            display: block; width: 100%; padding: 20px; margin-bottom: 15px;
            border-radius: 12px; border: none; font-size: 1.2rem; font-weight: 900;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: transform 0.1s;
        }
        .landing-btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--ui-gold); color: #2d3436; box-shadow: 0 5px 0 #b39207; }
        .btn-secondary { background: #485460; color: white; box-shadow: 0 5px 0 #1e272e; }

        .setup-input { 
            background: #1e272e; border: 1px solid #485460; color: white; 
            padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; margin-bottom: 15px; 
            font-size: 1rem;
        }
        label { display: block; text-align: left; font-size: 0.8rem; color: #808e9b; margin-bottom: 5px; }

        .rule-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        .rule-icon { font-size: 1.5rem; }
        .rule-text { font-size: 0.9rem; color: #d2dae2; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
        .stat-lbl { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .stat-num { font-size: 1.2rem; font-weight: 900; color: white; }

        /* PROMO SECTION */
        .promo-box {
            margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;
            border-top: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        .promo-title { font-size: 0.9rem; color: var(--ui-gold); margin-bottom: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .promo-img { width: 90px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .promo-buttons { display: flex; gap: 8px; justify-content: center; }
        .store-btn {
            flex: 1; padding: 10px; background: #34495e; border-radius: 8px; color: white;
            text-decoration: none; font-size: 0.8rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);
            transition: background 0.2s; white-space: nowrap;
        }
        .store-btn:hover { background: #2c3e50; }

        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 4000; }
        .invalid-shake { animation: shake 0.4s; color: var(--t-red) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        
        #mid-game-toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            background: #27ae60; color: white; padding: 20px 40px; border-radius: 50px;
            font-weight: 900; font-size: 1.2rem; z-index: 5000; pointer-events: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: 0.3s; text-align: center;
        }
        #mid-game-toast.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        #clear-bonus-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); text-align: center; z-index: 4600; pointer-events: none; width: 100%; opacity: 0; transition: opacity 0.5s ease; }
        #clear-bonus-overlay.visible { opacity: 1; }
        #clear-bonus-overlay h1 { font-size: 4rem; color: #fff; text-shadow: 0 0 20px var(--ui-gold); -webkit-text-stroke: 2px #e84118; margin: 0; }
        .animate-pop { animation: megaPop 0.8s forwards; }
        @keyframes megaPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="landing-screen" class="modal-overlay visible">
        <div class="modal-card">
            <h1 style="font-size: 3rem; margin-bottom: 5px; color:white;">Bricklayer</h1>
            <p style="color:#a4b0be; margin-bottom: 30px;">The Daily Word Puzzle</p>
            <button class="landing-btn btn-primary" onclick="setupGame()">Play Daily Puzzle</button>
            <button class="landing-btn btn-secondary" onclick="showDev()">Dev / Config</button>
        </div>
    </div>

    <div id="setup-screen" class="modal-overlay">
        <div class="modal-card">
            <h2>Config Settings</h2>
            <label>Hidden Word</label>
            <input type="text" id="cfg-word" class="setup-input" value="MUSTANG" style="text-transform:uppercase">
            <label>Daily Clue</label>
            <input type="text" id="cfg-clue" class="setup-input" value="Neigh, Sally!">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Cols</label><input type="number" id="cfg-cols" class="setup-input" value="6" min="4" max="8"></div>
                <div style="flex:1"><label>Rows</label><input type="number" id="cfg-rows" class="setup-input" value="8" min="5" max="12"></div>
            </div>
            <button class="game-btn btn-green" style="width:100%" onclick="setupGame()">Launch Custom</button>
        </div>
    </div>

    <div id="modal-welcome" class="modal-overlay">
        <div class="modal-card">
            <h2>How to Play</h2>
            <div class="rule-row"><div class="rule-icon">üëÜ</div><div class="rule-text"><b>Tap to Connect:</b> Select tiles in sequence.</div></div>
            <div class="rule-row"><div class="rule-icon">üêç</div><div class="rule-text"><b>Find the Snake:</b> The hidden word is buried in the wall.</div></div>
            <div class="rule-row"><div class="rule-icon">üß±</div><div class="rule-text"><b>Gravity:</b> Clearing bricks makes the wall collapse.</div></div>
            <div class="rule-row"><div class="rule-icon">üéí</div><div class="rule-text"><b>No Refills:</b> Clear every tile to win!</div></div>
            <button class="game-btn btn-green" style="width:100%; margin-top:10px" onclick="startGame()">Start</button>
        </div>
    </div>

    <div id="game-view">
        <div class="header-bar">
            <div class="stat-pill"><span>Time</span><span class="stat-val" id="timer-box">5:00</span></div>
            <div class="stat-pill"><span>Tiles</span><span class="stat-val" id="bag-count">96</span></div>
            <div class="stat-pill"><span>Score</span><span class="stat-val" style="color:var(--ui-gold)" id="score">0</span></div>
        </div>

        <div id="def-modal">
            <span id="def-word">WORD</span>
            <div id="def-text">Definition goes here...</div>
        </div>

        <div id="clue-bar">üïµÔ∏è <span id="clue-text">...</span></div>
        <div id="word-display">Ready</div>
        <div id="game-container"></div>

        <div class="controls">
            <button class="game-btn btn-end" onclick="confirmEndGame()">End Game</button>
            <button class="game-btn btn-green" onclick="submitWord()" style="flex:1.5">Submit</button>
            <button class="game-btn btn-red" onclick="clearSelection()">‚úï</button>
        </div>
    </div>

    <div id="modal-gameover" class="modal-overlay">
        <div class="modal-card">
            <h2 id="go-title">Game Over</h2>
            <div id="go-score" style="font-size:3.5rem; font-weight:900; color:white; margin-bottom:10px;">0</div>
            
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-lbl">Words</div><div class="stat-num" id="go-count">0</div></div>
                <div class="stat-box"><div class="stat-lbl">Time</div><div class="stat-num" id="go-time">0:00</div></div>
                <div class="stat-box" style="grid-column: span 2"><div class="stat-lbl">Longest</div><div class="stat-num" id="go-long">-</div></div>
                <div class="stat-box" style="grid-column: span 2"><div class="stat-lbl">Best</div><div class="stat-num" id="go-best">-</div></div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="game-btn btn-share" onclick="shareResult()">Share</button>
                <button class="game-btn btn-green" onclick="location.reload()">Retry</button>
            </div>

            <div class="promo-box">
                <div class="promo-title">PLAY SUSIE DENT'S MOBILE GAME</div>
                <img src="image_d88439.png" class="promo-img" alt="Two Words App">
                <div class="promo-buttons">
                    <a href="https://apps.apple.com/gb/app/two-words-with-susie-dent/id1514156691" target="_blank" class="store-btn">App Store</a>
                    <a href="https://play.google.com/store/apps/details?id=uk.co.twowaymedia.twowords2&hl=en_GB" target="_blank" class="store-btn">Google Play</a>
                </div>
            </div>
        </div>
    </div>

    <div id="mid-game-toast"><h2>Daily Word Found!</h2><p>Now clear the rest!</p></div>
    <div id="clear-bonus-overlay"><h1>BOARD<br>CLEARED!</h1><p style="color:white; font-size:2rem; font-weight:900;">+500 BONUS</p></div>
    <canvas id="confetti-canvas"></canvas>

    <script>
        const DICT_URL = 'https://raw.githubusercontent.com/dolph/dictionary/master/enable1.txt';
        let dictionary = new Set();
        
        const DEFAULT_DIST = [
            { l: 'A', v: 1, c: 10 }, { l: 'B', v: 3, c: 2 }, { l: 'C', v: 3, c: 1 }, { l: 'D', v: 2, c: 3 },
            { l: 'E', v: 1, c: 13 }, { l: 'F', v: 4, c: 2 }, { l: 'G', v: 2, c: 2 }, { l: 'H', v: 4, c: 3 },
            { l: 'I', v: 1, c: 8 }, { l: 'J', v: 8, c: 1 }, { l: 'K', v: 5, c: 1 }, { l: 'L', v: 1, c: 5 },
            { l: 'M', v: 3, c: 3 }, { l: 'N', v: 1, c: 6 }, { l: 'O', v: 1, c: 8 }, { l: 'P', v: 3, c: 3 },
            { l: 'Qu', v: 10, c: 1 }, { l: 'R', v: 1, c: 8 }, { l: 'S', v: 1, c: 3 }, { l: 'T', v: 1, c: 7 },
            { l: 'U', v: 1, c: 2 }, { l: 'V', v: 4, c: 1 }, { l: 'W', v: 4, c: 1 }, { l: 'X', v: 8, c: 1 },
            { l: 'Y', v: 4, c: 1 }, { l: 'Z', v: 10, c: 1 }
        ];

        let SETTINGS = {}, grid = [], deck = [], selected = [];
        let totalScore = 0, timer = 300, interval, gameStartTime = 0;
        let stats = { words: 0, longest: "", bestWord: "", bestScore: 0 };
        let hiddenFound = false, gameActive = false, isProcessing = false;
        let hasWon = false; // NEW FLAG
        let snakeIds = [], seed = 1, defTimeout = null;

        async function loadDict() {
            try {
                const r = await fetch(DICT_URL);
                const t = await r.text();
                t.split('\n').forEach(w => dictionary.add(w.trim().toUpperCase()));
            } catch(e) {}
        }
        loadDict();

        function seededRand() {
            var t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }

        // --- NAVIGATION ---
        function showDev() {
            document.getElementById('landing-screen').classList.remove('visible');
            document.getElementById('setup-screen').classList.add('visible');
        }

        function setupGame() {
            const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
            seed = parseInt(today);

            SETTINGS = {
                word: document.getElementById('cfg-word').value.toUpperCase(),
                clue: document.getElementById('cfg-clue').value,
                c: parseInt(document.getElementById('cfg-cols').value),
                r: parseInt(document.getElementById('cfg-rows').value),
                time: 300
            };
            dictionary.add(SETTINGS.word);

            // Hide Landing/Setup, Show Welcome
            document.getElementById('landing-screen').classList.remove('visible');
            document.getElementById('setup-screen').classList.remove('visible');
            document.getElementById('modal-welcome').classList.add('visible');
            
            buildGrid();
        }

        function buildGrid() {
            const container = document.getElementById('game-container');
            const maxW = Math.min(window.innerWidth - 20, 460);
            const tileW = Math.floor(maxW / (SETTINGS.c + 0.5));
            const tileH = Math.floor(tileW * 0.85);

            container.style.width = ((SETTINGS.c * tileW) + (tileW/2)) + 'px';
            container.style.height = (SETTINGS.r * tileH) + 'px';
            container.innerHTML = '';

            grid = Array.from({length: SETTINGS.r}, () => Array(SETTINGS.c).fill(null));
            
            const total = SETTINGS.c * SETTINGS.r;
            const fill = Math.max(0, total - SETTINGS.word.length);
            
            deck = []; let pool = [];
            DEFAULT_DIST.forEach(x => { for(let i=0; i<x.c; i++) pool.push(x); });
            
            for(let i=0; i<fill; i++) {
                if(pool.length === 0) DEFAULT_DIST.forEach(x => { for(let k=0; k<x.c; k++) pool.push(x); });
                const idx = Math.floor(seededRand() * pool.length);
                deck.push(pool.splice(idx, 1)[0]);
            }

            placeSnake();

            for(let r=0; r<SETTINGS.r; r++) {
                for(let c=0; c<SETTINGS.c; c++) {
                    let data = grid[r][c];
                    if(!data) data = deck.pop() || {l:'?', v:0};
                    createTile(r, c, data, tileW, tileH);
                }
            }
            
            if(SETTINGS.clue) {
                document.getElementById('clue-bar').style.display = "block";
                document.getElementById('clue-text').innerText = SETTINGS.clue;
            }
            updateBag();
        }

        function startGame() {
            document.getElementById('modal-welcome').classList.remove('visible');
            document.getElementById('game-view').style.display = 'flex';
            gameActive = true;
            gameStartTime = Date.now();
            interval = setInterval(tick, 1000);
            document.getElementById('game-container').onpointerdown = handleDown;
            document.addEventListener('pointerdown', globalTap); 
        }

        // --- GRID LOGIC ---
        function createTile(r, c, data, w, h) {
            const el = document.createElement('div');
            let cls = "cell";
            if("AEIOU".includes(data.l)) cls += ` bg-${data.l}`;
            else if(data.v >= 5) cls += " bg-epic";
            else if(data.v >= 3) cls += " bg-mid";
            else cls += " bg-cons";
            if(data.start) cls += " start-tile";

            el.className = cls;
            el.style.width = (w-4)+'px';
            el.style.height = (h-4)+'px';
            el.innerHTML = `<span class="tile-letter">${data.l}</span><span class="tile-score">${data.v}</span>`;

            let left = c * w; if(r % 2 !== 0) left += (w/2);
            el.style.left = left + 'px'; el.style.top = (r * h) + 'px';

            const tile = { el: el, r: r, c: c, l: data.l, v: data.v, snake: data.snake, start: data.start };
            el.tile = tile; grid[r][c] = tile; 
            if(tile.snake) snakeIds.push(tile);

            el.onpointerdown = (e) => { e.stopPropagation(); handleTap(e, tile); };
            document.getElementById('game-container').appendChild(el);
        }

        function placeSnake() {
            const letters = SETTINGS.word.split('');
            let placed = false, tries = 0;
            
            let hash = 0;
            for(let i=0; i<letters.length; i++) hash += letters[i].charCodeAt(0);
            let jump = (hash * 13) % 1000;
            for(let i=0; i<jump; i++) seededRand();

            while(!placed && tries < 2000) {
                for(let r=0; r<SETTINGS.r; r++) { for(let c=0; c<SETTINGS.c; c++) { if(grid[r][c]) grid[r][c] = null; } }
                let r = Math.floor(seededRand() * SETTINGS.r);
                let c = Math.floor(seededRand() * SETTINGS.c);
                if(tryPath(r, c, 0, letters)) placed = true;
                tries++;
            }
        }

        function tryPath(r, c, idx, letters) {
            if(idx >= letters.length) return true;
            if(grid[r][c]) return false;
            const l = letters[idx];
            const v = DEFAULT_DIST.find(x => x.l === l)?.v || 1;
            grid[r][c] = { l: l, v: v, snake: true, start: idx===0 };
            if(idx === letters.length - 1) return true;
            let neighbors = getNeighbors(r, c).filter(n => !grid[n.r][n.c]);
            neighbors.sort(() => seededRand() - 0.5);
            for(let n of neighbors) if(tryPath(n.r, n.c, idx+1, letters)) return true;
            grid[r][c] = null; return false;
        }

        function getNeighbors(r, c) {
            let n = [];
            if(c > 0) n.push({r:r, c:c-1});
            if(c < SETTINGS.c-1) n.push({r:r, c:c+1});
            const odd = (r % 2 !== 0);
            [r-1, r+1].forEach(nr => {
                if(nr >= 0 && nr < SETTINGS.r) {
                    if(odd) {
                        if(c < SETTINGS.c) n.push({r:nr, c:c});
                        if(c < SETTINGS.c-1) n.push({r:nr, c:c+1});
                    } else {
                        if(c > 0) n.push({r:nr, c:c-1});
                        if(c < SETTINGS.c) n.push({r:nr, c:c});
                    }
                }
            });
            return n;
        }

        // --- PLAY ---
        function handleTap(e, tile) {
            e.stopPropagation();
            if(!gameActive || isProcessing) return;
            hideDefinition();
            if(selected.length > 0 && selected[selected.length-1] === tile) { submitWord(); return; }
            if(!selected.includes(tile)) {
                if(selected.length > 0) {
                    const last = selected[selected.length-1];
                    const n = getNeighbors(last.r, last.c);
                    if(!n.some(xy => xy.r === tile.r && xy.c === tile.c)) clearSelection();
                }
                selected.push(tile); tile.el.classList.add('selected'); updateDisplay();
            } else {
                if(selected.length > 1 && selected[selected.length-2] === tile) {
                    selected.pop().el.classList.remove('selected'); updateDisplay();
                }
            }
        }

        function globalTap(e) {
            if(!e.target.closest('#def-modal') && !e.target.closest('.game-btn')) hideDefinition();
        }

        function handleDown(e) {
            if(!gameActive || isProcessing) return;
            isDragging = true; handleMove(e);
            document.addEventListener('pointermove', handleMove);
            document.addEventListener('pointerup', endDrag);
        }

        function handleMove(e) {
            if(!isDragging) return;
            let target = document.elementFromPoint(e.clientX, e.clientY);
            if(!target) return;
            let cell = target.closest('.cell');
            if(!cell || !cell.tileData) return;
            const tile = cell.tileData;
            if(!selected.includes(tile)) {
                if(selected.length > 0) {
                    const last = selected[selected.length - 1];
                    const isNeighbor = getNeighbors(last.r, last.c).some(n => n.r === tile.r && n.c === tile.c);
                    if(!isNeighbor) {
                        if(selected.length > 1 && selected[selected.length - 2] === tile) {
                            selected.pop().el.classList.remove('selected'); updateDisplay(); return;
                        }
                        clearSelection(); 
                    }
                }
                selected.push(tile); tile.el.classList.add('selected'); updateDisplay();
            }
        }

        function endDrag() { isDragging = false; document.removeEventListener('pointermove', handleMove); document.removeEventListener('pointerup', endDrag); }

        function submitWord() {
            if(!gameActive || isProcessing || selected.length < 2) return;
            const word = selected.map(t => t.l).join('').toUpperCase();
            
            if(!dictionary.has(word)) {
                document.getElementById('word-display').classList.add('invalid-shake');
                setTimeout(() => {
                    document.getElementById('word-display').classList.remove('invalid-shake');
                    clearSelection(); 
                }, 500);
                return;
            }

            showDefinition(word);
            isProcessing = true;
            const pts = selected.reduce((a,b) => a+b.v, 0) * selected.length;
            totalScore += pts; document.getElementById('score').innerText = totalScore;

            stats.words++;
            if(word.length > stats.longest.length) stats.longest = word;
            if(pts > stats.bestScore) { stats.bestScore = pts; stats.bestWord = word; }

            if(!hiddenFound && word === SETTINGS.word) {
                hiddenFound = true;
                const t = document.getElementById('mid-game-toast');
                t.classList.add('visible');
                document.getElementById('clue-bar').classList.add('solved');
                document.getElementById('clue-text').innerText = "Daily Word Found!";
                triggerConfetti();
                setTimeout(() => t.classList.remove('visible'), 3000);
            }

            selected.forEach(t => { t.el.classList.add('removing'); grid[t.r][t.c] = null; });
            setTimeout(() => {
                selected.forEach(t => t.el.remove());
                selected = []; updateDisplay(); applyGravity();
            }, 300);
        }

        function showDefinition(word) {
            clearTimeout(defTimeout);
            const modal = document.getElementById('def-modal');
            const defText = document.getElementById('def-text');
            const defWord = document.getElementById('def-word');
            
            defWord.innerText = word;
            defText.innerText = "Loading...";
            modal.classList.add('visible');

            fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`)
            .then(r => r.json())
            .then(d => {
                if(d[0]?.meanings[0]?.definitions[0]) {
                    defText.innerText = d[0].meanings[0].definitions[0].definition;
                } else defText.innerText = "No definition found.";
            }).catch(() => defText.innerText = "Definition unavailable.");

            defTimeout = setTimeout(hideDefinition, 5000);
        }

        function hideDefinition() {
            document.getElementById('def-modal').classList.remove('visible');
        }

        function applyGravity() {
            const cellEx = document.querySelector('.cell') || document.querySelector('.removing'); 
            if(!cellEx) { if(grid.flat().every(x => x === null)) endGame(true); return; }
            
            const w = parseFloat(cellEx.style.width) + 4;
            const h = parseFloat(cellEx.style.height) + 4;

            for(let c=0; c<SETTINGS.c; c++) {
                let write = SETTINGS.r - 1;
                for(let r=SETTINGS.r-1; r>=0; r--) {
                    if(grid[r][c]) {
                        let t = grid[r][c]; grid[r][c] = null; grid[write][c] = t; t.r = write;
                        let left = c * w; if(write % 2 !== 0) left += (w/2);
                        t.el.style.top = (write * h) + 'px'; t.el.style.left = left + 'px';
                        write--;
                    }
                }
            }

            setTimeout(() => {
                let activeCols = [];
                for(let c=0; c<SETTINGS.c; c++) { if(grid.some(row => row[c] !== null)) activeCols.push(c); }

                if(activeCols.length < SETTINGS.c) {
                    let offset = Math.floor((SETTINGS.c - activeCols.length)/2);
                    let newGrid = Array.from({length: SETTINGS.r}, () => Array(SETTINGS.c).fill(null));
                    activeCols.forEach((oldC, i) => {
                        let newC = i + offset;
                        for(let r=0; r<SETTINGS.r; r++) {
                            if(grid[r][oldC]) {
                                let t = grid[r][oldC]; t.c = newC;
                                let left = newC * w; if(t.r % 2 !== 0) left += (w/2);
                                t.el.style.left = left + 'px'; t.el.style.top = (t.r * h) + 'px';
                                newGrid[r][newC] = t;
                            }
                        }
                    });
                    grid = newGrid;
                }
                updateBag();
                if(grid.flat().every(x => x === null)) endGame(true);
                else isProcessing = false;
            }, 350);
        }

        // --- HELPERS ---
        function updateDisplay() {
            const txt = selected.map(t => t.l).join('').toUpperCase();
            const pts = selected.reduce((a,b) => a+b.v, 0) * selected.length;
            document.getElementById('word-display').innerText = txt ? `${txt} (${pts})` : "Ready";
        }
        function clearSelection() { selected.forEach(t => t.el.classList.remove('selected')); selected = []; updateDisplay(); }
        function toggleSnake(show) { snakeIds.forEach(t => { if(t.el) show ? t.el.classList.add('snake-highlight') : t.el.classList.remove('snake-highlight'); }); }
        function updateBag() { 
            let count = grid.flat().filter(x => x !== null).length;
            document.getElementById('bag-count').innerText = count; 
        }
        function tick() {
            timer--;
            const m = Math.floor(timer/60); const s = timer % 60;
            document.getElementById('timer-box').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            if(document.querySelectorAll('.cell:not(.removing)').length === 0 && gameActive) endGame(true);
            if(timer <= 0) endGame(false);
        }

        function confirmEndGame() {
            if(confirm("Are you sure you want to end the game?")) { endGame(false); }
        }

        function endGame(won) {
            if(!gameActive) return;
            gameActive = false; clearInterval(interval);
            hasWon = won; // Store won state
            
            const el = 300 - timer;
            document.getElementById('go-title').innerText = won ? "VICTORY!" : "TIME UP";
            document.getElementById('go-title').style.color = won ? "#2ecc71" : "#e74c3c";
            
            // Calculate and display Final Score (including bonus)
            const finalScore = won ? (totalScore + 500) : totalScore;
            document.getElementById('go-score').innerText = finalScore;
            
            document.getElementById('go-count').innerText = stats.words;
            document.getElementById('go-time').innerText = `${Math.floor(el/60)}:${(el%60).toString().padStart(2,'0')}`;
            document.getElementById('go-best').innerText = stats.bestWord ? `${stats.bestWord} (${stats.bestScore})` : "-";
            document.getElementById('go-long').innerText = stats.longest || "-";
            
            if(won) {
                triggerConfetti();
                document.getElementById('clear-bonus-overlay').classList.add('visible');
                document.getElementById('clear-bonus-overlay').classList.add('animate-pop');
                setTimeout(() => {
                    document.getElementById('clear-bonus-overlay').classList.remove('visible');
                    document.getElementById('modal-gameover').classList.add('visible');
                }, 2000);
            } else {
                document.getElementById('modal-gameover').classList.add('visible');
            }
        }

        function shareResult() {
            // FIX: Correct Score & Text
            const finalScore = hasWon ? (totalScore + 500) : totalScore;
            const hiddenStatus = hiddenFound ? "Hidden Word Found!" : "Hidden Word Missed";
            
            // Spoiler check for best word display
            const bestDisplay = (stats.bestWord === SETTINGS.word) ? "?????" : stats.bestWord;
            const bestScoreText = stats.bestScore > 0 ? `(${stats.bestScore})` : "";

            const txt = `Word Crumble üß±\n‚≠ê ${finalScore}\nüèÜ Best: ${bestDisplay} ${bestScoreText}\nüîé ${hiddenStatus}`;
            navigator.clipboard.writeText(txt);
            alert("Copied!");
        }

        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let p = Array.from({length: 150}, () => ({x: window.innerWidth/2, y: window.innerHeight/2, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20, c: `hsl(${Math.random()*360},100%,50%)`, l: 1}));
            function loop() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                p.forEach((x, i) => { x.x+=x.vx; x.y+=x.vy; x.vy+=0.5; x.l-=0.02; ctx.globalAlpha=Math.max(0,x.l); ctx.fillStyle=x.c; ctx.fillRect(x.x,x.y,8,8); if(x.l<=0)p.splice(i,1); });
                if(p.length) requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>